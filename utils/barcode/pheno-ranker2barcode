#!/usr/bin/env python3
#
#   A script that creates 2D-barcodes(QR) from Pheno-Ranker export data
#
#   Last Modified: Dec/01/2023
#
#   Version 0.00
#
#   Copyright (C) 2023 Manuel Rueda - CNAG (manuel.rueda@cnag.eu)
#
#   License: Artistic License 2.0
#
#   If this program helps you in your research, please cite.

import json
import qrcode
import argparse
import os

def convert_json_to_qr(json_file, output_dir):
    # Load the JSON data
    try:
        with open(json_file, 'r') as file:
            data = json.load(file)
    except Exception as e:
        print(f"Error reading JSON file: {e}")
        return

    # Create the output directory if it doesn't exist
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    # Generate a QR code for each "binary_digit_string" key
    for key, value in data.items():
        if 'binary_digit_string' in value:
            binary_digit_string = value['binary_digit_string']
            safe_key = key.replace(':', '_')  # Replace colons for file naming

            qr = qrcode.QRCode(
                version=1,
                error_correction=qrcode.constants.ERROR_CORRECT_L,
                box_size=10,
                border=4,
            )
            qr.add_data(binary_digit_string)
            qr.make(fit=True)

            img = qr.make_image(fill_color="black", back_color="white")
            img_path = os.path.join(output_dir, f"{safe_key}.png")
            img.save(img_path)

    print("QR codes generated successfully in", output_dir)

def main():
    parser = argparse.ArgumentParser(description='Convert JSON values to QR codes.')
    parser.add_argument('-i', '--input', required=True, help='Input JSON file path')
    parser.add_argument('-o', '--output', default='qr_codes', help='Output directory for QR codes')

    args = parser.parse_args()

    convert_json_to_qr(args.input, args.output)

if __name__ == "__main__":
    main()
