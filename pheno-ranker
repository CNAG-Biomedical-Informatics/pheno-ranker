#!/usr/bin/env perl
#
#   A script that ranks individuals against a cohort (BFF)
#
#   Last Modified: Apr/18/2023
#
#   Version 1.0.0
#
#   Copyright (C) 2023 Manuel Rueda - CNAG (manuel.rueda@cnag.crg.eu)
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 3 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, see <https://www.gnu.org/licenses/>.
#
#   If this program helps you in your research, please cite.

use strict;
use warnings;
use autodie;
use feature      qw(say);
use Getopt::Long qw(:config no_ignore_case);
use Pod::Usage;
use Data::Dumper;
use Sys::Hostname;
use POSIX           qw(strftime);
use Term::ANSIColor qw(:constants);
use FindBin         qw($Bin);
use lib $Bin;
use Pheno::Ranker qw($VERSION write_json);

##### Main #####
pheno_ranker();
################
exit;

sub pheno_ranker {

    # Defining a few variables
    my $out_file   = 'matrix.txt';
    my $align_file = 'alignment.txt';
    my $log_file   = 'pheno-ranker-log.json';

    # Reading arguments
    GetOptions(
        'reference|r=s'          => \my $reference_file,                       # string
        'target|t=s'             => \my $target_file,                          # string
        'weights|w=s'            => \my $weights_file,                         # string
        'o=s'                    => \$out_file,                                # string
        'max-out:i'              => \my $max_out,                              # integer
        'hpo'                    => \my $hpo,                                  # flag
        'export|e'               => \my $export,                               # flag
        'align|a:s'              => \my $align,                                # opt-string (defined)
        'sort-by=s'              => \my $sort_by,                              # string
        'included-terms=s{1,11}' => \my @included_terms,                       # array
        'excluded-terms=s{1,11}' => \my @excluded_terms,                       # array
        'no-age'                 => \my $no_age,                               # flag
        'help|?'                 => \my $help,                                 # flag
        'log:s'                  => \my $log,                                  # opt-string (defined)
        'man'                    => \my $man,                                  # flag
        'debug=i'                => \my $debug,                                # integer
        'verbose|'               => \my $verbose,                              # flag
        'no-color|nc'            => \my $no_color,                             # flag
        'version|V'              => sub { say "$0 Version $VERSION"; exit; }
    ) or pod2usage(2);
    pod2usage(1)                              if $help;
    pod2usage( -verbose => 2, -exitval => 0 ) if $man;
    pod2usage(
        -message => "Please specify a valid reference-cohort for -r\n",
        -exitval => 1
    ) unless $reference_file;

    # Turning color off if argument <--no-color>
    $ENV{'ANSI_COLORS_DISABLED'} = 1 if $no_color;

    # Start printing to STDOUT
    say BOLD CYAN program_header($VERSION), RESET if $verbose;

    ######################
    # START PHENO-RANKER #
    ######################

    # Load data as hashref
    my $data = {
        reference_file => $reference_file,
        target_file    => $target_file,
        weights_file   => $weights_file,
        hpo            => $hpo,
        hpo_file       => undef,
        align          => $align,
        align_file     => $align_file,
        export         => $export,
        out_file       => $out_file,
        max_out        => $max_out,
        sort_by        => $sort_by,
        included_terms => \@included_terms,
        excluded_terms => \@excluded_terms,
        no_age         => $no_age,
        log            => $log,
        debug          => $debug,
        verbose        => $verbose
    };

    # Create object
    my $ranker = Pheno::Ranker->new($data);

    # Run method
    $ranker->run();

    # Create log if <--log>
    write_log( $log ? $log : $log_file, $data, $VERSION )
      if defined $log;

    ####################
    # END PHENO-RANKER #
    ####################
}

sub write_log {

    my ( $log, $data, $VERSION ) = @_;

    # NB: We will use anonymous (no effect on $data)
    chomp( my $ncpuhost = qx{/usr/bin/nproc} ) // 1;

    my $info = {
        date     => ( strftime "%a %b %e %H:%M:%S %Y", localtime ),
        ncpuhost => ( 0 + $ncpuhost ),                                # coercing it to be a number
        hostname => hostname,
        id       => time . substr( "00000$$", -5 ),                   # string
        version  => $VERSION,
        user     => $ENV{LOGNAME} || $ENV{USER} || getpwuid($<)
    };

    # Saving file
    say BOLD GREEN "Writing <$log> file\n" if $data->{verbose};
    write_json(
        {
            filepath => $log,
            data     => { info => $info, data => $data }
        }
    );
}

sub program_header {

    my $VERSION = shift;
    my $str     = <<EOF;
****************************************
*    Rank against cohort (BFF/PXF)     *
*          - PHENO-RANKER -            *
*          Version: $VERSION            *
*      (C) 2023 Manuel Rueda, PhD      *
*    GNU General Public License v3     *
****************************************
EOF
    return $str;
}

=head1 NAME

pheno-ranker: A script that compares a given BFF/PXF file against a BFF/PXF cohort

=head1 SYNOPSIS


pheno-ranker -r <individuals.json> -t <patient.json> [-options]

     Arguments:                       
       -r|reference-file              BFF/PXF file (JSON array)
       -t|target-file                 BFF/PXF file (JSON)

     Options:
       -o                             Output file [matrix.txt]
       -debug                         Print debugging (from 1 to 5, being 5 max)
       -e|export                      Export miscellanea JSON files
       -excluded-terms                Excluded BFF/PXF terms
       -h|help                        Brief help message
       -hpo                           Include HPO ascendant terms (if present)
       -included-terms                Included BFF/PXF terms
       -log                           Save log file (JSON). If no argument is given then the log is named [pheno-ranker-log.json]
       -man                           Full documentation
       -max-out                       Print only N of comparisons (used with --t)  [50]
       -nc|-no-color                  Don't print colors to STDOUT
       -no-age                        Don't include any age-related variable
       -sort-by                       Sort reference-patient comparison by Hamming-distance or Jaccard-index [>hamming|jaccard]
       -v|verbose                     Verbosity on
       -V|version                     Print version
       -w|weights                     YAML file with weights

=head1 DESCRIPTION

pheno-ranker: A script that compares a given BFF/PXF file against a BFF/PXF cohort

=head1 SUMMARY

pheno-ranker: A script that compares and ranks (by dissimilarity) a given BFF/PXF file against a BFF/PXF cohort

=head1 INSTALLATION

 $ cpanm sudo --installdeps .

=head3 System requirements

  * Ideally a Debian-based distribution (Ubuntu or Mint), but any other (e.g., CentOs, OpenSuse) should do as well.
  * Perl 5 (>= 5.10 core; installed by default in most Linux distributions). Check the version with "perl -v"
  * 1GB of RAM.
  * 1 core (it only uses one core per job).
  * At least 1GB HDD.

=head1 HOW TO RUN PHENO-RANKER

For executing pheno-ranker you will need:

=over

=item Input file(s):
      
A PXF or BFF file(s) in JSON format. The reference cohort must be a JSON array, where each individual data are consolidated in one object. 

If no C<--t> argument is provided then it will compute intra-cohort comparison only. If C<--t> argument is provided then the target JSON will be compared against the C<-r> reference cohort.

=back

B<Examples:>

 $ ./pheno-ranker -r phenopackets.json  # intra-cohort

 $ ./pheno-ranker -r phenopackets.json -o my_matrix.txt # intra-cohort

 $ ./pheno-ranker -r phenopackets.json -w weights.yaml --excluded-terms sex ethnicity exposures # intra-cohort with weights

 $ $path/pheno-ranker -t patient.json -r individuals.json -max-out 100 # patient-cohort

=head2 COMMON ERRORS AND SOLUTIONS

 * Error message: Foo
   Solution: Bar

 * Error message: Foo
   Solution: Bar

=head1 AUTHOR 

Written by Manuel Rueda, PhD. Info about CNAG can be found at L<https://www.cnag.crg.eu>.

=head1 COPYRIGHT AND LICENSE

This PERL file is copyrighted. See the LICENSE file included in this distribution.

=cut
